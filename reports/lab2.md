# 实验报告

## 总结实现的功能

### 重写 `sys_get_time` 和 `sys_task_info`

重点在于 `fn set_val_in_user_memory<T: Sized>(ptr: *mut T, val: &T) -> isize;`, 这个函数用于将 `val` 写入虚拟地址 `ptr` 所对应的物理地址。物理地址可能是不连续的，这里复用了 `translated_byte_buffer` 来获取物理地址的 `buffers`，再依次写入。

### `mmap` 和 `munmap` 匿名映射

核心逻辑实现在了 `TaskManager` 中，主要是为了能直接对当前任务的 `memory_set` 进行修改。

`mmap`：根据 `start` 和 `len`，计算出虚拟地址的起止位置，进而调用 `memory_set.insert_framed_area()` 完成内存分配和在页表中的相应更新。

`munmap`: 比照 `insert_framed_area`，我实现了 `remove_framed_area`。它遍历所有 `areas`，找到其中起止位置都符合的 `MapArea`，并调用其 `unmap` 方法，释放内存并将页表更新。


## 简答作业

##### 1. 请列举 SV39 页表页表项的组成，描述其中的标志位有何作用？

页表项共 64 位，其中 [53:10] 这 54 位是物理页号，最低的 8 位 [7:0] 则是标志位。

0 -> V: 页表项是否合法
1 -> R: 虚拟页面是否可读
2 -> W: 虚拟页面是否可写
3 -> X: 虚拟页面是否可取指令
4 -> U: U 特权级下是否被允许访问
5 -> G: 未涉及
6 -> A: 记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被访问过；
7 -> D: 记录自从页表项上的这一位被清零之后，页表项的对应虚拟页表是否被修改过。

##### 2. 缺页

###### 2.1. 请问哪些异常可能是缺页导致的？

`mcause` 记录了异常的原因，当 `Exception Code` 是以下值时，异常原因与缺页有关：

* 12: Instruction page fault
* 13: Load page fault	
* 15: Store/AMO page fault

以上信息来自[该页面](https://five-embeddev.com/riscv-isa-manual/latest/machine.html#sec:mcause)
第 3.1.15. 节 Machine Cause Register (mcause)。

###### 2.2. 发生缺页时，描述相关重要寄存器的值，上次实验描述过的可以简略。

* `scause`: 中断/异常发生时， CSR 寄存器 scause 中会记录其信息， Interrupt 位记录是中断还是异常，Exception Code 记录中断/异常的种类。

* `sstatus`: 记录处理器当前状态，其中 SPP 段记录当前特权等级。

* `stvec`: 记录处理 trap 的入口地址，现有两种模式 Direct 和 Vectored。

* `sscratch`: 其中的值是指向hart相关的 S 态上下文的指针，比如内核栈的指针。

* `sepc`: trap 发生时会将当前指令的下一条指令地址写入其中，用于 trap 处理完成后返回。

* `stval`: trap 发生进入S态时会将异常信息写入，用于帮助处理 trap，其中会保存导致缺页异常的虚拟地址。

以上内容来自完整版教程。

###### 2.3. 这样做（Lazy 策略）有哪些好处？

可以避免一些无用的加载，从而提高性能。

###### 2.4. 处理 10G 连续的内存页面，对应的 SV39 页表大致占用多少内存 (估算数量级即可)？

PAGE_SIZE 是 4KB，对应一个页表项 64位 即 8B。前者是后者的 512 倍。

10GB 内存对应的页表占：10G / 512 约为 20MB。

###### 2.5. 请简单思考如何才能实现 Lazy 策略，缺页时又如何处理？描述合理即可，不需要考虑实现。

当请求分配内存时并不真的分配，而是记录下来。当访问该虚拟页面时，触发缺页异常，进入 trap handler，此时进行内存分配和加载。

###### 2.6. 此时（swap 策略）页面失效如何表现在页表项(PTE)上？

标志位 V 置为 0。

##### 3.双页表与单页表

###### 3.1. 在单页表情况下，如何更换页表？

直接赋值 `satp` 寄存器。

###### 3.2. 单页表情况下，如何控制用户态无法访问内核页面？

将内核页面的 PTE 的 U 标志位设为 0。

###### 3.3. 单页表有何优势？

在内核和用户态之间转换时不需要更换页表。

###### 3.4. 双页表实现下，何时需要更换页表？假设你写一个单页表操作系统，你会选择何时更换页表

双页表：内核态/用户态转换时，切换用户任务时
蛋页表：仅当切换用户任务时


## 荣誉准则

1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 以下各位 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：

无

2. 此外，我也参考了 以下资料 ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

rCore-Tutorial-Book 第三版

3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。
